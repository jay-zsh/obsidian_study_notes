#### **本章学习目标**
熟练掌握使用DML（数据操作语言）进行数据的增、删、改、查操作，特别是掌握各种复杂的查询技巧，包括单表查询、多表连接、子查询和分组聚合。

我们沿用第五章创建的`Student`， `Course`， `SC`表作为示例。

---

### **`★★★ 6.1 简单查询（单表）`**

核心命令是 `SELECTi(Π筛选列)`。语法骨架：
```sql
SELECT [DISTINCT] column1, column2, ...
FROM table_name
[WHERE condition]
[ORDER BY column [ASC|DESC]];
```

-   **查询指定列**
    ```sql
    -- 查询全体学生的学号与姓名
    SELECT Sno, Sname FROM Student;
    -- 查询全体学生的详细信息
    SELECT * FROM Student; 
    ```

-   **`DISTINCT` 消除重复行**
    ```sql
    -- 查询所有有学生选修的课程号（去掉重复的课程号）
    SELECT DISTINCT Cno FROM SC;
    ```

-   **`WHERE` 条件查询 - 重点！**
    -   **比较**：`=, <>, >, >=, <, <=`
        ```sql
        SELECT Sname, Sage FROM Student WHERE Sage < 20;
        ```
    -   **范围**：`BETWEEN ... AND ...` / `NOT BETWEEN ... AND ...`
        ```sql
        SELECT Sname, Sage FROM Student WHERE Sage BETWEEN 18 AND 20;
        ```
    -   **集合**：`IN (...)` / `NOT IN (...)`
        ```sql
        SELECT Sname, Sdept FROM Student WHERE Sdept IN ('计算机系', '数学系');
        ```
    -   **字符匹配**：`LIKE` - **`难点`**
        -   `%`：匹配任意长度（长度可以为0）的字符串。
        -   `_`：匹配单个字符。
        ```sql
        SELECT Sname FROM Student WHERE Sname LIKE '刘%'; -- 查询姓刘的学生
        SELECT Sname FROM Student WHERE Sname LIKE '欧阳_'; -- 查询姓欧阳且名为单个字的学生
        SELECT Cname FROM Course WHERE Cname LIKE '%数据库%'; -- 查询课程名中包含“数据库”的课程
        ```
    -   **空值判断**：`IS NULL` / `IS NOT NULL`
        ```sql
        SELECT Sno, Cno FROM SC WHERE Grade IS NULL; -- 查询缺考的学生（成绩为空）
        ```

-   **`ORDER BY` 排序**
    ```sql
    -- 按年龄降序排列学生
    SELECT * FROM Student ORDER BY Sage DESC;
    -- 先按系别升序，同系的学生按年龄降序排列
    SELECT * FROM Student ORDER BY Sdept ASC, Sage DESC;
    ```

---

### **`★★★ 6.2 连接查询（多表）`**

**核心：根据表间的关联字段，将多个表的数据组合在一起。** 这是关系数据库的强大之处。

-   **`等值连接`** 与 **`自然连接`**
    ```sql
    -- 查询每个学生及其选修课程的成绩（等值连接，结果会有两个Sno列）
    SELECT Student.*, SC.* FROM Student, SC WHERE Student.Sno = SC.Sno;

    -- 更常用的写法：使用标准的JOIN语法（自然连接效果）
    SELECT Student.Sno, Sname, Cno, Grade
    FROM Student 
    INNER JOIN SC ON Student.Sno = SC.Sno;
    ```

-   **`外连接` - `难点`**
    -   **左外连接**：返回左表（`Student`）的所有记录，即使右表（`SC`）中没有匹配的记录。
        ```sql
        -- 查询所有学生的选课情况（包括没选课的学生）
        SELECT Student.Sno, Sname, Cno, Grade
        FROM Student 
        LEFT JOIN SC ON Student.Sno = SC.Sno;
        -- 对于没选课的学生，Cno和Grade显示为NULL
        ```
    -   **右外连接**：与左外连接相反，返回右表的所有记录。
    -   **全外连接**：MySQL不直接支持，但可通过联合左右连接实现。

---

### **`★★★★ 6.3 嵌套查询（子查询）` - 最高难度**

**概念：一个`SELECT-FROM-WHERE`查询块嵌套在另一个查询块中。** 外层查询称为父查询，内层称为子查询。

-   **`IN` 子查询**：子查询返回一个集合。
    ```sql
    -- 查询选修了“数据库”课程的学生学号
    SELECT Sno FROM SC 
    WHERE Cno IN (
        SELECT Cno FROM Course WHERE Cname = '数据库'
    );

    -- 等价于连接查询：
    SELECT SC.Sno FROM SC 
    INNER JOIN Course ON SC.Cno = Course.Cno 
    WHERE Course.Cname = '数据库';
    ```

-   **`比较运算符` 子查询**：子查询返回单个值。
    ```sql
    -- 查询与“张三”在同一个系的学生
    SELECT Sno, Sname, Sdept FROM Student
    WHERE Sdept = (
        SELECT Sdept FROM Student WHERE Sname = '张三'
    );
    ```

-   **`EXISTS` 子查询 - 关键难点**：子查询不返回数据，只返回逻辑真/假。
    ```sql
    -- 查询选修了CS001号课程的学生姓名
    SELECT Sname FROM Student
    WHERE EXISTS (
        SELECT * FROM SC 
        WHERE SC.Sno = Student.Sno AND SC.Cno = 'CS001'
    );
    -- 理解：对于Student表中的每一行，都去SC表检查是否存在对应的选课记录。存在则取出该学生姓名。
    ```

---

### **`★★★ 6.4 分组和函数查询`**

-   **聚合函数**：对一组值执行计算，返回单个值。

|函数|说明|
|:--|:--|
|`COUNT()`|统计行数|
|`SUM()`|求和|
|`AVG()`|求平均值|
|`MAX()`|求最大值|
|`MIN()`|求最小值|

```sql
    SELECT COUNT(*) FROM Student; -- 学生总人数
    SELECT AVG(Grade) FROM SC WHERE Cno='CS001'; -- CS001课程的平均成绩
    ```

-   **`GROUP BY` 分组 - 难点**
    ```sql
    -- 统计每个课程号及相应的选课人数
    SELECT Cno, COUNT(Sno) AS '选课人数'
    FROM SC 
    GROUP BY Cno;
    ```

-   **`HAVING` 短语 - 难点中的难点**
    -   **`WHERE` 与 `HAVING` 的区别**：
        -   **`WHERE`** 在分组**前**对原始数据进行筛选，**不能使用聚合函数**。
        -   **`HAVING`** 在分组**后**对分组的结果进行筛选，**可以使用聚合函数**。
    ```sql
    -- 查询选修了3门以上课程的学生学号
    SELECT Sno 
    FROM SC 
    GROUP BY Sno 
    HAVING COUNT(*) > 3;

    -- 查询平均成绩大于80分的学生学号和平均成绩
    SELECT Sno, AVG(Grade) AS AvgGrade
    FROM SC 
    GROUP BY Sno 
    HAVING AVG(Grade) > 80;
    ```

---

### **`★ 6.5 添加、删除和修改数据`**

-   **插入数据 `INSERT`**
    ```sql
    -- 插入一条完整记录
    INSERT INTO Student (Sno, Sname, Ssex, Sage, Sdept) 
    VALUES ('2023001', '张三', '男', 19, '计算机系');
    -- 如果值列表顺序与表结构完全一致，可省略列名
    INSERT INTO Student VALUES ('2023002', '李四', '女', 20, '数学系');
    ```

-   **修改数据 `UPDATE`**
    ```sql
    -- 将学号为2023001的学生的年龄改为20岁
    UPDATE Student SET Sage = 20 WHERE Sno = '2023001';
    -- 将所有学生的年龄增加1岁
    UPDATE Student SET Sage = Sage + 1;
    -- **【警告】不带WHERE条件的UPDATE会更新整个表！**
    ```

-   **删除数据 `DELETE`**
    ```sql
    -- 删除学号为2023002的学生记录
    DELETE FROM Student WHERE Sno = '2023002';
    -- 删除所有学生记录
    DELETE FROM Student;
    -- **【警告】不带WHERE条件的DELETE会清空整个表！**
    ```

---

### **本章总结与复习建议**

-   **核心技能**：**`SELECT` 查询是灵魂**，必须做到灵活运用。特别是 `WHERE`, `JOIN`, `GROUP BY` + `HAVING`。
-   **核心难点**：**多表连接**、**EXISTS子查询**、**WHERE和HAVING的区别**。这些是需要反复练习和理解的重点。
-   **学习方法**：**多写多练**。为示例表填充一些数据，然后尝试用各种查询去获取你想要的结果。将自然语言问题转化为SQL语句是最终目标。
