# 12.3 迭代

我们可以使用简洁的增强型for循环遍历Java的`HashSet`：

```java
Set<String> s = new HashSet<>();
s.add("Tokyo");
s.add("Lagos");
for (String city : s) {
    System.out.println(city);
}
```

但若尝试对自实现的`ArraySet`进行同样操作，则会报错。如何实现这种遍历能力？

---

## 增强型for循环

首先理解增强型for循环的内部机制。我们可以将其"转换"为传统的手动迭代方式：

```java
Set<String> s = new HashSet<>();
...
for (String city : s) {
    ...
}
```

等价于：

```java
Set<String> s = new HashSet<>();
...
Iterator<String> seer = s.iterator();
while (seer.hasNext()) {
    String city = seer.next();
    ...
}
```

这种解构帮助我们理解如何为自定义类实现迭代功能，其核心在于_迭代器_对象。

---

## 迭代器实现

本节探讨如何构建支持迭代的类。以编译以下代码为例：

```java
List<Integer> friends = new ArrayList<Integer>();
Iterator<Integer> seer = friends.iterator();

while(seer.hasNext()) {
    System.out.println(seer.next());
}
```

需满足两个条件：
1. List接口需实现`iterator()`方法
2. Iterator接口需包含`hasNext()`和`next()`方法

实现路径：
- List接口继承Iterable接口（通过Collection中间接口）
- Iterable接口声明`iterator()`抽象方法
- Iterator接口声明`hasNext()`和`next()`方法

```java
public interface Iterable<T> {
    Iterator<T> iterator();
}

public interface Iterator<T> {
    boolean hasNext();
    T next();
}
```

**注意事项：**
- 当`hasNext()`返回false时调用`next()`将抛出`NoSuchElementException`
- 不能假定用户总是先调用`hasNext()`再调用`next()`

---

## 具体实现案例

为`ArraySet`添加迭代功能，需创建嵌套迭代器类：

```java
private class ArraySetIterator implements Iterator<T> {
    private int wizPos;

    public ArraySetIterator() {
        wizPos = 0;
    }

    public boolean hasNext() {
        return wizPos < size;
    }

    public T next() {
        T returnItem = items[wizPos];
        wizPos += 1;
        return returnItem;
    }
}
```

随后在`ArraySet`类中实现Iterable接口：

```java
public Iterator<T> iterator() {
    return new ArraySetIterator();
}
```

最终实现效果：

```java
ArraySet<Integer> aset = new ArraySet<>();
...
for (int i : aset) {
    System.out.println(i);
}
```

---

## 完整实现代码

```java
import java.util.Iterator;

public class ArraySet<T> implements Iterable<T> {
    private T[] items;
    private int size;

    public ArraySet() {
        items = (T[]) new Object[100];
        size = 0;
    }

    public boolean contains(T x) {
        for (int i = 0; i < size; i++) {
            if (items[i].equals(x)) {
                return true;
            }
        }
        return false;
    }

    public void add(T x) {
        if (x == null) {
            throw new IllegalArgumentException("禁止添加null值");
        }
        if (contains(x)) {
            return;
        }
        items[size] = x;
        size++;
    }

    public int size() {
        return size;
    }

    public Iterator<T> iterator() {
        return new ArraySetIterator();
    }

    private class ArraySetIterator implements Iterator<T> {
        private int wizPos;

        public ArraySetIterator() {
            wizPos = 0;
        }

        public boolean hasNext() {
            return wizPos < size;
        }

        public T next() {
            T returnItem = items[wizPos];
            wizPos++;
            return returnItem;
        }
    }

    public static void main(String[] args) {
        ArraySet<Integer> aset = new ArraySet<>();
        aset.add(5);
        aset.add(23);
        aset.add(42);

        // 迭代示例
        for (int i : aset) {
            System.out.println(i);
        }
    }
}
```